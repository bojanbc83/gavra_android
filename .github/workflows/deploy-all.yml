name: üöÄ Deploy All Platforms

# Deploy to iOS, Google Play, and Huawei simultaneously
on:
  workflow_dispatch:
    inputs:
      submit_for_review:
        description: 'Submit for review after upload? (iOS & Huawei)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      release_notes:
        description: 'Release notes for Huawei (optional)'
        required: false
        default: 'Ispravke gre≈°aka i pobolj≈°anja performansi.'
      force_replace_review:
        description: 'Automatically replace existing in-review submissions (use with caution)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.6'
  BUNDLE_ID: 'com.gavra013.gavra013ios'
  APP_ID: '6757114361'
  VERSION_ID: 'f7bded3a-0055-40c8-9d90-2ac33b85c7a2'

jobs:
  google-play:
    name: üì± Google Play Alpha
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Prepare agconnect-services.json
        env:
          AGC_BASE64: ${{ secrets.AGC_BASE64 || '' }}
        run: |
          mkdir -p assets android/app
          if [ -n "$AGC_BASE64" ]; then
            echo "$AGC_BASE64" | base64 --decode > assets/agconnect-services.json
            echo "$AGC_BASE64" | base64 --decode > android/app/agconnect-services.json
          else
            echo '{ "client": { "package_name": "com.gavra013.gavra_android" } }' > assets/agconnect-services.json
            echo '{ "client": { "package_name": "com.gavra013.gavra_android" } }' > android/app/agconnect-services.json
          fi

      - name: Restore keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > gavra-release-key-production.keystore
          mkdir -p android
          cp gavra-release-key-production.keystore android/
          cat > android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=../gavra-release-key-production.keystore
          EOF

      - name: Get version info
        id: version
        run: |
          VERSION_LINE=$(grep "^version:" pubspec.yaml)
          VERSION_NAME=$(echo "$VERSION_LINE" | sed 's/version: \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          VERSION_CODE=$(echo "$VERSION_LINE" | sed 's/version: [0-9]*\.[0-9]*\.[0-9]*+\([0-9]*\)/\1/')
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "üìå Version: $VERSION_NAME ($VERSION_CODE)"

      - name: Get dependencies
        run: flutter pub get

      - name: Build AAB
        run: flutter build appbundle --release

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.gavra013.gavra_android
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: alpha
          status: completed

  huawei-appgallery:
    name: üì± Huawei AppGallery
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Prepare agconnect-services.json
        env:
          AGC_BASE64: ${{ secrets.AGC_BASE64 }}
        run: |
          mkdir -p assets android/app
          echo "$AGC_BASE64" | base64 --decode > assets/agconnect-services.json
          echo "$AGC_BASE64" | base64 --decode > android/app/agconnect-services.json

      - name: Restore keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          cat > android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF

      - name: Get version info
        id: version
        run: |
          VERSION_LINE=$(grep "^version:" pubspec.yaml)
          VERSION_NAME=$(echo "$VERSION_LINE" | sed 's/version: \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          VERSION_CODE=$(echo "$VERSION_LINE" | sed 's/version: [0-9]*\.[0-9]*\.[0-9]*+\([0-9]*\)/\1/')
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload to Huawei
        env:
          HUAWEI_CLIENT_ID: ${{ secrets.AGC_CLIENT_ID }}
          HUAWEI_CLIENT_SECRET: ${{ secrets.AGC_CLIENT_SECRET }}
          HUAWEI_APP_ID: ${{ secrets.AGC_APP_ID }}
          VERSION: ${{ steps.version.outputs.VERSION_NAME }}
          RELEASE_NOTES: ${{ github.event.inputs.release_notes }}
        run: |
          TOKEN_RESPONSE=$(curl -s -X POST "https://connect-api.cloud.huawei.com/api/oauth2/v1/token" -H "Content-Type: application/json" -d "{\"client_id\": \"$HUAWEI_CLIENT_ID\", \"client_secret\": \"$HUAWEI_CLIENT_SECRET\", \"grant_type\": \"client_credentials\"}")
          ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "‚ùå Failed to get token"
            exit 1
          fi
          
          UPLOAD_URL_RESPONSE=$(curl -s -X GET "https://connect-api.cloud.huawei.com/api/publish/v2/upload-url?appId=$HUAWEI_APP_ID&suffix=apk" -H "Authorization: Bearer $ACCESS_TOKEN" -H "client_id: $HUAWEI_CLIENT_ID")
          UPLOAD_URL=$(echo $UPLOAD_URL_RESPONSE | jq -r '.uploadUrl')
          AUTH_CODE=$(echo $UPLOAD_URL_RESPONSE | jq -r '.authCode')
          
          UPLOAD_RESPONSE=$(curl -s -X POST "$UPLOAD_URL" -F "file=@build/app/outputs/flutter-apk/app-release.apk" -F "authCode=$AUTH_CODE" -F "fileCount=1")
          FILE_DEST=$(echo $UPLOAD_RESPONSE | jq -r '.result.UploadFileRsp.fileInfoList[0].fileDestUlr')
          
          UPDATE_RESPONSE=$(curl -s -X PUT "https://connect-api.cloud.huawei.com/api/publish/v2/app-file-info?appId=$HUAWEI_APP_ID" -H "Authorization: Bearer $ACCESS_TOKEN" -H "client_id: $HUAWEI_CLIENT_ID" -H "Content-Type: application/json" -d "{\"fileType\": 5, \"files\": [{\"fileName\": \"app-release.apk\", \"fileDestUrl\": \"$FILE_DEST\"}]}")
          
          if [ "${{ github.event.inputs.submit_for_review }}" = "true" ]; then
            SUBMIT_RESPONSE=$(curl -s -X POST "https://connect-api.cloud.huawei.com/api/publish/v2/app-submit?appId=$HUAWEI_APP_ID" -H "Authorization: Bearer $ACCESS_TOKEN" -H "client_id: $HUAWEI_CLIENT_ID" -H "Content-Type: application/json" -d "{\"releaseType\": 1}")
            echo "‚úÖ Submitted for review"
          fi

  ios-app-store:
    name: üçé iOS App Store
    runs-on: macos-latest
    env:
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Codemagic CLI
        run: pip install codemagic-cli-tools

      - name: Get dependencies
        run: flutter pub get

      - name: Write certificate key to file
        run: |
          echo "${{ secrets.CERTIFICATE_PRIVATE_KEY }}" > /tmp/cert_key.pem
          echo "CERTIFICATE_PRIVATE_KEY=/tmp/cert_key.pem" >> $GITHUB_ENV

      - name: Setup keychain
        run: keychain initialize

      - name: Fetch signing files
        run: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create

      - name: Setup certificates
        env:
          CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
        run: keychain add-certificates

      - name: Setup code signing
        run: xcode-project use-profiles

      - name: Get version info
        id: version
        run: |
          VERSION_LINE=$(grep "^version:" pubspec.yaml)
          VERSION_NAME=$(echo "$VERSION_LINE" | sed 's/version: \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          VERSION_CODE=$(echo "$VERSION_LINE" | sed 's/version: [0-9]*\.[0-9]*\.[0-9]*+\([0-9]*\)/\1/')
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Build IPA
        run: flutter build ipa --release --build-name=${{ steps.version.outputs.VERSION_NAME }} --build-number=${{ steps.version.outputs.VERSION_CODE }} --export-options-plist=$HOME/export_options.plist

      - name: Upload to App Store
        run: app-store-connect publish --path build/ios/ipa/*.ipa

      - name: Wait for processing
        run: sleep 180

      - name: Link build
        id: link_build
        run: |
          BUILD_NUM="${{ steps.version.outputs.VERSION_CODE }}"
          APP_ID="6757114361"
          VERSION_ID="f7bded3a-0055-40c8-9d90-2ac33b85c7a2"
          for i in 1 2 3; do
            BUILD_ID=$(app-store-connect builds list --app-id "$APP_ID" --build-version-number "$BUILD_NUM" --json 2>/dev/null | python3 -c "import sys,json; data=json.load(sys.stdin); print(data[0]['id'] if data else '')" 2>/dev/null || echo "")
            if [ -n "$BUILD_ID" ]; then
              echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
              app-store-connect app-store-versions modify --id "$VERSION_ID" --build-id "$BUILD_ID" || true
              break
            fi
            sleep 60
          done

      - name: Submit for review
        if: ${{ github.event.inputs.submit_for_review == 'true' }}
        run: |
          VERSION_ID="f7bded3a-0055-40c8-9d90-2ac33b85c7a2"
          if [ -n "${{ steps.link_build.outputs.BUILD_ID }}" ]; then
            app-store-connect app-store-version-submissions create --app-store-version-id "$VERSION_ID" || echo "‚ö†Ô∏è Manual submission needed"
          fi
