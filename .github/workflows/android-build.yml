# 🤖 GitHub Actions - Gavra Bus Android Build Workflow
# Automatski Android APK build sa email delivery za Bilevskog i Bojana
# Unlimited builds - GitHub Free plan! 🆓

name: 🚀 Android Build & Delivery

# Trigger na svaki push na main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  
  # Manual trigger opcija
  workflow_dispatch:

jobs:
  android-build:
    name: 🤖 Build Android APK (Samsung + Huawei)
    runs-on: ubuntu-latest
    
    steps:
      # 📥 Checkout kod
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        
      # ☕ Setup Java 17 (potrebno za Flutter/Android)
      - name: ☕ Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      # 🐦 Setup Flutter Stable
      - name: 🐦 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true
          
      # 🔧 Verify Flutter Installation
      - name: 🔧 Flutter Doctor
        run: |
          flutter doctor -v
          flutter --version
          
      # 📦 Download Dependencies
      - name: 📦 Get Flutter Dependencies
        run: |
          flutter clean
          flutter pub get
          
      # 🔥 Verify Firebase Configuration
      - name: 🔥 Verify Android Firebase Setup
        run: |
          echo "🔍 Checking Firebase Android configuration..."
          if [ -f android/app/google-services.json ]; then
            echo "✅ google-services.json found"
          else
            echo "❌ google-services.json missing!"
            exit 1
          fi
          
      # 📱 Verify Android Permissions & OneSignal
      - name: 📱 Verify Android Configuration
        run: |
          echo "🔍 Checking Android permissions and OneSignal..."
          
          # Check location permissions
          if grep -q "ACCESS_FINE_LOCATION" android/app/src/main/AndroidManifest.xml; then
            echo "✅ Location permissions configured"
          else
            echo "❌ Location permissions missing!"
          fi
          
          # Check OneSignal configuration
          if grep -q "onesignal_app_id" android/app/src/main/AndroidManifest.xml; then
            echo "✅ OneSignal configured"
          else
            echo "❌ OneSignal not configured!"
          fi
          
          # Check Huawei compatibility
          if grep -q "Huawei" lib/services/notification_service.dart; then
            echo "✅ Huawei compatibility implemented"
          else
            echo "⚠️ Huawei fallback check needed"
          fi
          
      # 🚀 Build Release APK
      - name: 🚀 Build Android Release APK
        run: |
          echo "🔨 Building Android APK with Firebase + OneSignal + Huawei support..."
          
          # Set build number based on GitHub run number
          BUILD_NUMBER=${{ github.run_number }}
          BUILD_NAME="1.0.$BUILD_NUMBER"
          
          echo "📱 Building version: $BUILD_NAME (Build: $BUILD_NUMBER)"
          
          flutter build apk --release \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --verbose
            
      # 📋 APK Info
      - name: 📋 APK Build Information
        run: |
          echo "📱 APK Build Complete!"
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "✅ APK Created: $APK_SIZE"
            echo "📍 Location: $APK_PATH"
            echo "🔢 Build Number: ${{ github.run_number }}"
            echo "📅 Build Date: $(date '+%Y-%m-%d %H:%M:%S')"
          else
            echo "❌ APK not found!"
            exit 1
          fi
          
      # 📤 Upload APK as Artifact
      - name: 📤 Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gavra-bus-android-v1.0.${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          
      # 📧 Send Email Notification with APK
      - name: 📧 Email APK to Android Users
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 🚀 Gavra Bus Android Build v1.0.${{ github.run_number }} Ready!
          to: |
            gavriconi19@gmail.com
            bilevski@gmail.com
            bojan.colleague@gmail.com
          from: Gavra Bus CI/CD <${{ secrets.EMAIL_USERNAME }}>
          html_body: |
            <h2>🚀 Gavra Bus Android App - New Build Ready!</h2>
            
            <h3>📱 Build Information:</h3>
            <ul>
              <li><strong>Version:</strong> 1.0.${{ github.run_number }}</li>
              <li><strong>Build Date:</strong> ${{ github.event.head_commit.timestamp }}</li>
              <li><strong>Commit:</strong> ${{ github.event.head_commit.message }}</li>
              <li><strong>Developer:</strong> ${{ github.event.head_commit.author.name }}</li>
            </ul>
            
            <h3>✅ Features Included:</h3>
            <ul>
              <li>🔥 Firebase push notifications</li>
              <li>📱 OneSignal cross-platform notifications</li>
              <li>🌐 Real-time bus tracking</li>
              <li>📍 Location-based notifications</li>
              <li>📞 Huawei Mate Pro 40 compatibility</li>
              <li>⚡ Samsung device optimizations</li>
            </ul>
            
            <h3>📥 Download & Install:</h3>
            <p><strong>APK Download:</strong> 
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
            Download APK from GitHub Actions
            </a></p>
            
            <h4>📱 Installation Steps:</h4>
            <ol>
              <li>Click the download link above</li>
              <li>Go to "Artifacts" section</li>
              <li>Download "gavra-bus-android-v1.0.${{ github.run_number }}"</li>
              <li>Extract and install APK on your device</li>
              <li>Enable "Install from unknown sources" if prompted</li>
            </ol>
            
            <h3>🔧 For Support:</h3>
            <p>Contact: gavriconi19@gmail.com</p>
            <p>GitHub: <a href="https://github.com/${{ github.repository }}">${{ github.repository }}</a></p>
            
            <hr>
            <p><em>📅 Generated: $(date '+%Y-%m-%d %H:%M:%S') | 🤖 GitHub Actions CI/CD</em></p>
          attachments: build/app/outputs/flutter-apk/app-release.apk
          
      # 🎉 Build Success Notification
      - name: 🎉 Build Success Summary
        if: success()
        run: |
          echo "🎉 ANDROID BUILD SUCCESS!"
          echo "✅ APK built for Samsung & Huawei devices"
          echo "✅ Email sent to Bilevski & Bojan"
          echo "✅ Artifacts uploaded to GitHub"
          echo "📱 Version: 1.0.${{ github.run_number }}"
          echo "🚀 Ready for testing!"
