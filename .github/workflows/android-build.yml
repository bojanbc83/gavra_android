# ğŸ¤– GitHub Actions - Gavra Bus Android Build Workflow
# Automatski Android APK build sa email delivery za Bilevskog i Bojana
# Unlimited builds - GitHub Free plan! ğŸ†“

name: ğŸš€ Android Build & Delivery

# Trigger na svaki push na main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  
  # Manual trigger opcija
  workflow_dispatch:

jobs:
  android-build:
    name: ğŸ¤– Build Android APK (Samsung + Huawei)
    runs-on: ubuntu-latest
    
    steps:
      # ğŸ“¥ Checkout kod
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # â˜• Setup Java 17 (potrebno za Flutter/Android)
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      # ğŸ¦ Setup Flutter Stable
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true
          
      # ğŸ”§ Verify Flutter Installation
      - name: ğŸ”§ Flutter Doctor
        run: |
          flutter doctor -v
          flutter --version
          
      # ğŸ“¦ Download Dependencies
      - name: ğŸ“¦ Get Flutter Dependencies
        run: |
          flutter clean
          flutter pub get
          
      # ğŸ”¥ Verify Firebase Configuration
      - name: ğŸ”¥ Verify Android Firebase Setup
        run: |
          echo "ğŸ” Checking Firebase Android configuration..."
          if [ -f android/app/google-services.json ]; then
            echo "âœ… google-services.json found"
          else
            echo "âŒ google-services.json missing!"
            exit 1
          fi
          
      # ğŸ“± Verify Android Permissions & OneSignal
      - name: ğŸ“± Verify Android Configuration
        run: |
          echo "ğŸ” Checking Android permissions and OneSignal..."
          
          # Check location permissions
          if grep -q "ACCESS_FINE_LOCATION" android/app/src/main/AndroidManifest.xml; then
            echo "âœ… Location permissions configured"
          else
            echo "âŒ Location permissions missing!"
          fi
          
          # Check OneSignal configuration
          if grep -q "onesignal_app_id" android/app/src/main/AndroidManifest.xml; then
            echo "âœ… OneSignal configured"
          else
            echo "âŒ OneSignal not configured!"
          fi
          
          # Check Huawei compatibility
          if grep -q "Huawei" lib/services/notification_service.dart; then
            echo "âœ… Huawei compatibility implemented"
          else
            echo "âš ï¸ Huawei fallback check needed"
          fi
          
      # ğŸš€ Build Release APK
      - name: ğŸš€ Build Android Release APK
        run: |
          echo "ğŸ”¨ Building Android APK with Firebase + OneSignal + Huawei support..."
          
          # Set build number based on GitHub run number
          BUILD_NUMBER=${{ github.run_number }}
          BUILD_NAME="1.0.$BUILD_NUMBER"
          
          echo "ğŸ“± Building version: $BUILD_NAME (Build: $BUILD_NUMBER)"
          
          flutter build apk --release \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --verbose
            
      # ğŸ“‹ APK Info
      - name: ğŸ“‹ APK Build Information
        run: |
          echo "ğŸ“± APK Build Complete!"
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "âœ… APK Created: $APK_SIZE"
            echo "ğŸ“ Location: $APK_PATH"
            echo "ğŸ”¢ Build Number: ${{ github.run_number }}"
            echo "ğŸ“… Build Date: $(date '+%Y-%m-%d %H:%M:%S')"
          else
            echo "âŒ APK not found!"
            exit 1
          fi
          
      # ğŸ“¤ Upload APK as Artifact
      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gavra-bus-android-v1.0.${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          
      # ğŸ“§ Send Email Notification with APK
      - name: ğŸ“§ Email APK to Android Users
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ğŸš€ Gavra Bus Android Build v1.0.${{ github.run_number }} Ready!
          to: |
            gavriconi19@gmail.com
            bilevski@gmail.com
            bojan.colleague@gmail.com
          from: Gavra Bus CI/CD <${{ secrets.EMAIL_USERNAME }}>
          html_body: |
            <h2>ğŸš€ Gavra Bus Android App - New Build Ready!</h2>
            
            <h3>ğŸ“± Build Information:</h3>
            <ul>
              <li><strong>Version:</strong> 1.0.${{ github.run_number }}</li>
              <li><strong>Build Date:</strong> ${{ github.event.head_commit.timestamp }}</li>
              <li><strong>Commit:</strong> ${{ github.event.head_commit.message }}</li>
              <li><strong>Developer:</strong> ${{ github.event.head_commit.author.name }}</li>
            </ul>
            
            <h3>âœ… Features Included:</h3>
            <ul>
              <li>ğŸ”¥ Firebase push notifications</li>
              <li>ğŸ“± OneSignal cross-platform notifications</li>
              <li>ğŸŒ Real-time bus tracking</li>
              <li>ğŸ“ Location-based notifications</li>
              <li>ğŸ“ Huawei Mate Pro 40 compatibility</li>
              <li>âš¡ Samsung device optimizations</li>
            </ul>
            
            <h3>ğŸ“¥ Download & Install:</h3>
            <p><strong>APK Download:</strong> 
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
            Download APK from GitHub Actions
            </a></p>
            
            <h4>ğŸ“± Installation Steps:</h4>
            <ol>
              <li>Click the download link above</li>
              <li>Go to "Artifacts" section</li>
              <li>Download "gavra-bus-android-v1.0.${{ github.run_number }}"</li>
              <li>Extract and install APK on your device</li>
              <li>Enable "Install from unknown sources" if prompted</li>
            </ol>
            
            <h3>ğŸ”§ For Support:</h3>
            <p>Contact: gavriconi19@gmail.com</p>
            <p>GitHub: <a href="https://github.com/${{ github.repository }}">${{ github.repository }}</a></p>
            
            <hr>
            <p><em>ğŸ“… Generated: $(date '+%Y-%m-%d %H:%M:%S') | ğŸ¤– GitHub Actions CI/CD</em></p>
          attachments: build/app/outputs/flutter-apk/app-release.apk
          
      # ğŸ‰ Build Success Notification
      - name: ğŸ‰ Build Success Summary
        if: success()
        run: |
          echo "ğŸ‰ ANDROID BUILD SUCCESS!"
          echo "âœ… APK built for Samsung & Huawei devices"
          echo "âœ… Email sent to Bilevski & Bojan"
          echo "âœ… Artifacts uploaded to GitHub"
          echo "ğŸ“± Version: 1.0.${{ github.run_number }}"
          echo "ğŸš€ Ready for testing!"
