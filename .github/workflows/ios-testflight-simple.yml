name: ðŸŽ iOS TestFlight Build (Simple)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ios:
    name: Build iOS
    runs-on: macos-latest

    steps:
    - name: ðŸ“¦ Checkout
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: ðŸ”§ Install Dependencies
      run: flutter pub get

    - name: ðŸŽ Build iOS (No Code Sign)
      run: |
        cd ios
        rm -rf Pods build ~/Library/Developer/Xcode/DerivedData/* || true
        pod deintegrate || true
        pod install --repo-update --clean-install
        cd ..
        flutter clean
        flutter pub get
        flutter build ios --release --no-codesign --verbose

    - name: ðŸ—ï¸ Build Archive with Full Automatic Signing
      run: |
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath Runner.xcarchive \
          CODE_SIGN_STYLE="Automatic" \
          DEVELOPMENT_TEAM="6CY9Q44KMQ" \
          -allowProvisioningUpdates \
          -allowProvisioningDeviceRegistration \
          archive

    - name: ðŸ“¦ Export IPA with Automatic Signing
      run: |
        cd ios
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>teamID</key>
            <string>6CY9Q44KMQ</string>
        </dict>
        </plist>
        EOF

        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath export \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates

    - name: ðŸš€ Upload to TestFlight
      run: |
        cd ios/export
        xcrun altool --upload-app \
          --type ios \
          --file *.ipa \
          --username "gavra.gajic.vanja@gmail.com" \
          --password "rjal-rlql-xytn-kshx" \
          --verbose

    - name: âœ… Success
      run: echo "ðŸŽ‰ TestFlight upload successful!"
