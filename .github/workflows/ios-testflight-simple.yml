name: üçé iOS TestFlight Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ios-testflight:
    name: üöÄ Deploy to TestFlight
    runs-on: macos-latest
    
    steps:
    - name: üì± Checkout
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.2'
        channel: 'stable'
        cache: true
        
    - name: üì¶ Get dependencies
      run: flutter pub get
      
    - name: üîç Analyze
      run: flutter analyze --no-fatal-infos || echo "Analysis warnings ignored"
      
    - name: üß™ Test
      run: flutter test || echo "Tests skipped"
      
    - name: üçé Build iOS
      run: |
        cd ios
        pod install --repo-update
        flutter build ios --release --no-codesign
        
    - name: üîê Setup Signing
      env:
        P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        MOBILEPROVISION_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        P12_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
      run: |
        # Debug: Check base64 format
        echo "P12_BASE64 first 100 chars:"
        echo "$P12_BASE64" | head -c 100
        echo ""
        
        # Decode with cleanup and validation
        echo "$P12_BASE64" | tr -d '\n\r\t ' | base64 -d > certificate.p12
        echo "$MOBILEPROVISION_BASE64" | tr -d '\n\r\t ' | base64 -d > profile.mobileprovision
        
        # Verify P12 file format
        echo "P12 file info:"
        file certificate.p12
        openssl pkcs12 -info -in certificate.p12 -noout -passin pass:"$P12_PASSWORD" || echo "P12 validation failed"
        
        # Create and setup keychain
        security create-keychain -p "build123" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "build123" build.keychain
        
        # Try import with different methods
        echo "Attempting certificate import..."
        security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -A || {
          echo "First import failed, trying without -A flag..."
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
        }
        
        # Set keychain permissions
        security set-key-partition-list -S apple-tool:,apple: -s -k "build123" build.keychain
        
        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        
        # Verify signing identity
        security find-identity -v -p codesigning build.keychain
        
    - name: üèóÔ∏è Build Archive
      run: |
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath Runner.xcarchive \
          archive
          
    - name: üì¶ Export IPA
      run: |
        cd ios
        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath export \
          -exportOptionsPlist <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
        </dict>
        </plist>
        EOF
        
    - name: üöÄ Upload to TestFlight
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      run: |
        cd ios/export
        xcrun altool --upload-app -f *.ipa \
          -u "$APPLE_ID" \
          -p "$APPLE_PASSWORD" \
          --type ios
          
    - name: ‚úÖ Success
      run: echo "üéâ TestFlight upload successful!"
