name: ðŸš€ Release â€” All Platforms (skeleton)

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'none'
        type: choice
        options:
          - 'none'
          - 'patch'
          - 'minor'
          - 'major'
      release_tag:
        description: 'Optional tag to create (e.g. v1.2.3)'
        required: false
        default: ''
      release_notes:
        description: 'Release notes'
        required: false
        default: 'Bug fixes and improvements.'
      confirm:
        description: 'Set to true to actually perform bump/push/tag. Default is false (dry-run).'
        required: true
        default: 'false'
      force_replace_review:
        description: 'When true, replace existing in-review submissions for platforms that support it (dangerous).'
        required: true
        default: 'false'
      submit_ios:
        description: 'Trigger iOS upload workflow?'
        required: true
        default: 'false'
        type: choice
        options: ['true','false']
      submit_google:
        description: 'Trigger Google Play upload workflow?'
        required: true
        default: 'false'
        type: choice
        options: ['true','false']
      submit_huawei:
        description: 'Trigger Huawei upload workflow?'
        required: true
        default: 'false'
        type: choice
        options: ['true','false']

jobs:
  prepare-version:
    name: Prepare version (dry-run by default)
    runs-on: ubuntu-latest
    outputs:
      new_version_name: ${{ steps.get_version.outputs.new_version_name }}
      new_version_code: ${{ steps.get_version.outputs.new_version_code }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show current version
        run: |
          VERSION_LINE=$(grep "^version:" pubspec.yaml || true)
          echo "Current: $VERSION_LINE"

      - name: Bump version (optional)
        if: ${{ github.event.inputs.bump_type != 'none' && github.event.inputs.confirm == 'true' }}
        run: |
          python3 - <<'PY'
import re,sys
fn='pubspec.yaml'
with open(fn,'r') as f:
    s=f.read()
m=re.search(r'^version:\s*([0-9]+\.[0-9]+\.[0-9]+)\+([0-9]+)',s,flags=re.M)
if not m:
    print('Could not parse version from pubspec.yaml',file=sys.stderr); sys.exit(1)
major,minor,patch = m.group(1).split('.')
build=int(m.group(2))
bt='${{ github.event.inputs.bump_type }}'
if bt=='patch':
    patch=str(int(patch)+1)
elif bt=='minor':
    minor=str(int(minor)+1); patch='0'
elif bt=='major':
    major=str(int(major)+1); minor='0'; patch='0'
build+=1
new=f'{major}.{minor}.{patch}+{build}'
ns=re.sub(r'(version:\s*)([0-9]+\.[0-9]+\.[0-9]+\+[0-9]+)',r'\1'+new,s,flags=re.M)
with open(fn,'w') as f:
    f.write(ns)
print('Bumped version to',new)
          print('new_version='+new)
PY

      - name: Commit & push bumped pubspec (if any)
        if: ${{ github.event.inputs.bump_type != 'none' && github.event.inputs.confirm == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "chore(release): bump version via workflow (${GITHUB_RUN_ID})" || echo "no changes to commit"
          git push origin HEAD:${{ github.ref }} || git push

      - name: Get final version info
        id: get_version
        run: |
          VERSION_LINE=$(grep "^version:" pubspec.yaml || true)
          VERSION_NAME=$(echo "$VERSION_LINE" | sed 's/version: \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/')
          VERSION_CODE=$(echo "$VERSION_LINE" | sed 's/version: [0-9]\+\.[0-9]\+\.[0-9]\++\([0-9]\+\)/\1/')
          echo "new_version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "new_version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Final version: $VERSION_NAME ($VERSION_CODE)"

  trigger-uploads:
    name: Trigger platform uploads
    needs: prepare-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for context)
        uses: actions/checkout@v4

      - name: Optionally trigger Google Play closed-testing
        if: ${{ github.event.inputs.submit_google == 'true' }}
        uses: peter-evans/workflow-dispatch@v1
        with:
          workflow: google-closed-testing.yml
          ref: ${{ github.ref }}
          inputs: |
            version_name: '${{ needs.prepare-version.outputs.new_version_name }}'
            version_code: '${{ needs.prepare-version.outputs.new_version_code }}'
            release_notes: '${{ github.event.inputs.release_notes }}'
            track: 'alpha'

      - name: Optionally trigger Huawei upload (and submit for review when requested)
        if: ${{ github.event.inputs.submit_huawei == 'true' }}
        uses: peter-evans/workflow-dispatch@v1
        with:
          workflow: huawei-production.yml
          ref: ${{ github.ref }}
          inputs: |
            submit_for_review: '${{ github.event.inputs.submit_huawei }}'
            release_notes: '${{ github.event.inputs.release_notes }}'
            force_replace_review: '${{ github.event.inputs.force_replace_review }}'

      - name: Optionally trigger iOS upload
        if: ${{ github.event.inputs.submit_ios == 'true' }}
        uses: peter-evans/workflow-dispatch@v1
        with:
          workflow: ios-production.yml
          ref: ${{ github.ref }}
          inputs: |
            submit_for_review: '${{ github.event.inputs.submit_ios }}'
            release_notes: '${{ github.event.inputs.release_notes }}'
            force_replace_review: '${{ github.event.inputs.force_replace_review }}'

      - name: Summary
        run: |
          echo "Release workflow executed. Confirm=${{ github.event.inputs.confirm }}"
          echo "Triggered: iOS=${{ github.event.inputs.submit_ios }}, Google=${{ github.event.inputs.submit_google }}, Huawei=${{ github.event.inputs.submit_huawei }}"

# NOTE: This is a skeleton workflow. It performs a safe dry-run by default (confirm=false).
# To enable automatic bump & triggers set 'confirm' to 'true' when dispatching the workflow.
