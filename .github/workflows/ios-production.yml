name: üçé iOS Production Release

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.1)'
        required: true
        default: '1.0.1'

env:
  FLUTTER_VERSION: '3.35.6'
  BUNDLE_ID: 'com.gavra013.gavra013ios'
  APP_ID: '6757114361'

jobs:
  build-and-submit:
    name: üöÄ Build & Submit to App Store
    runs-on: macos-latest
    env:
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Codemagic CLI Tools
        run: pip install codemagic-cli-tools

      - name: Get dependencies
        run: flutter pub get

      - name: Setup keychain
        run: keychain initialize

      - name: Fetch signing files
        run: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create

      - name: Setup certificates
        run: keychain add-certificates

      - name: Setup code signing
        run: xcode-project use-profiles

      - name: Get latest build number
        id: build_info
        run: |
          LATEST_BUILD=$(app-store-connect get-latest-testflight-build-number "$APP_ID" 2>/dev/null || echo "0")
          NEW_BUILD=$((LATEST_BUILD + 1))
          echo "BUILD_NUMBER=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "üì± New build number: $NEW_BUILD"

      - name: Build iOS App
        run: |
          flutter build ipa --release \
            --build-name=${{ github.event.inputs.version_name }} \
            --build-number=${{ steps.build_info.outputs.BUILD_NUMBER }} \
            --export-options-plist=$HOME/export_options.plist

      - name: Upload to App Store Connect
        run: |
          app-store-connect publish --path build/ios/ipa/*.ipa
          echo "‚úÖ Build uploaded!"

      - name: Wait for processing
        run: |
          echo "‚è≥ Waiting 3 minutes for Apple to process build..."
          sleep 180

      - name: Setup Node.js for API calls
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create and Submit App Store Version
        run: |
          npm install jsonwebtoken
          
          node << 'EOF'
          const jwt = require('jsonwebtoken');
          const https = require('https');
          
          const ISSUER_ID = process.env.APP_STORE_CONNECT_ISSUER_ID;
          const KEY_ID = process.env.APP_STORE_CONNECT_KEY_IDENTIFIER;
          const PRIVATE_KEY = process.env.APP_STORE_CONNECT_PRIVATE_KEY;
          const APP_ID = '6757114361';
          const VERSION = '${{ github.event.inputs.version_name }}';
          const BUILD_NUMBER = '${{ steps.build_info.outputs.BUILD_NUMBER }}';
          
          function generateToken() {
            const now = Math.floor(Date.now() / 1000);
            return jwt.sign(
              { iss: ISSUER_ID, iat: now, exp: now + 1200, aud: 'appstoreconnect-v1' },
              PRIVATE_KEY,
              { algorithm: 'ES256', header: { alg: 'ES256', kid: KEY_ID, typ: 'JWT' } }
            );
          }
          
          function apiRequest(method, path, body = null) {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.appstoreconnect.apple.com',
                path: `/v1${path}`,
                method: method,
                headers: {
                  'Authorization': `Bearer ${generateToken()}`,
                  'Content-Type': 'application/json'
                }
              };
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    resolve(data ? JSON.parse(data) : {});
                  } else {
                    reject(new Error(`API ${res.statusCode}: ${data}`));
                  }
                });
              });
              
              req.on('error', reject);
              if (body) req.write(JSON.stringify(body));
              req.end();
            });
          }
          
          async function main() {
            try {
              // 1. Get the build ID for our build number
              console.log(`üîç Finding build ${BUILD_NUMBER}...`);
              const builds = await apiRequest('GET', `/builds?filter[app]=${APP_ID}&filter[version]=${BUILD_NUMBER}&limit=1`);
              
              if (!builds.data || builds.data.length === 0) {
                throw new Error(`Build ${BUILD_NUMBER} not found!`);
              }
              const buildId = builds.data[0].id;
              console.log(`‚úÖ Found build ID: ${buildId}`);
              
              // 2. Check if version exists, create if not
              console.log(`üìù Checking App Store version ${VERSION}...`);
              let versionId;
              
              try {
                const versions = await apiRequest('GET', `/apps/${APP_ID}/appStoreVersions?filter[versionString]=${VERSION}&filter[platform]=IOS`);
                if (versions.data && versions.data.length > 0) {
                  versionId = versions.data[0].id;
                  console.log(`‚úÖ Found existing version: ${versionId}`);
                }
              } catch (e) {
                console.log('Version not found, will create...');
              }
              
              if (!versionId) {
                console.log(`üìù Creating App Store version ${VERSION}...`);
                const newVersion = await apiRequest('POST', '/appStoreVersions', {
                  data: {
                    type: 'appStoreVersions',
                    attributes: {
                      platform: 'IOS',
                      versionString: VERSION,
                      releaseType: 'AFTER_APPROVAL'
                    },
                    relationships: {
                      app: { data: { type: 'apps', id: APP_ID } }
                    }
                  }
                });
                versionId = newVersion.data.id;
                console.log(`‚úÖ Created version: ${versionId}`);
              }
              
              // 3. Set build for version
              console.log(`üîó Linking build ${BUILD_NUMBER} to version ${VERSION}...`);
              await apiRequest('PATCH', `/appStoreVersions/${versionId}/relationships/build`, {
                data: { type: 'builds', id: buildId }
              });
              console.log('‚úÖ Build linked!');
              
              // 4. Create review submission
              console.log('üöÄ Submitting for App Store review...');
              await apiRequest('POST', '/reviewSubmissions', {
                data: {
                  type: 'reviewSubmissions',
                  attributes: {},
                  relationships: {
                    app: { data: { type: 'apps', id: APP_ID } }
                  }
                }
              });
              
              // 5. Add version to submission and submit
              const submissions = await apiRequest('GET', `/reviewSubmissions?filter[app]=${APP_ID}&filter[state]=READY_FOR_REVIEW`);
              if (submissions.data && submissions.data.length > 0) {
                const submissionId = submissions.data[0].id;
                
                // Add item to submission
                await apiRequest('POST', '/reviewSubmissionItems', {
                  data: {
                    type: 'reviewSubmissionItems',
                    relationships: {
                      reviewSubmission: { data: { type: 'reviewSubmissions', id: submissionId } },
                      appStoreVersion: { data: { type: 'appStoreVersions', id: versionId } }
                    }
                  }
                });
                
                // Submit
                await apiRequest('PATCH', `/reviewSubmissions/${submissionId}`, {
                  data: {
                    type: 'reviewSubmissions',
                    id: submissionId,
                    attributes: { submitted: true }
                  }
                });
                
                console.log('üéâ Successfully submitted for App Store review!');
              }
              
            } catch (error) {
              console.error('‚ùå Error:', error.message);
              console.log('‚ö†Ô∏è Build is uploaded. You may need to manually submit in App Store Connect.');
              process.exit(0); // Don't fail the workflow
            }
          }
          
          main();
          EOF

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.event.inputs.version_name }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Summary
        run: |
          echo "## üéâ iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ steps.build_info.outputs.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build uploaded and submitted for review!" >> $GITHUB_STEP_SUMMARY
