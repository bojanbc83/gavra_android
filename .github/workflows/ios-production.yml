name: ðŸŽ¯ iOS TestFlight Production Build

on:
  workflow_dispatch:

jobs:
  ios:
    name: ðŸŽ Build & Upload iOS
    runs-on: macos-latest

    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ðŸ¦ Setup Flutter 3.24.0
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: ðŸ“¥ Install Flutter Dependencies
      run: flutter pub get

    - name: ðŸ”§ Setup iOS Certificates & Provisioning
      env:
        P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        MOBILEPROVISION_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        echo "ðŸ” Setting up iOS certificates and provisioning profile..."

        # Create certificates directory
        mkdir -p ~/certificates

        # Decode P12 certificate
        echo "$P12_BASE64" | base64 -d > ~/certificates/certificate.p12

        # Decode provisioning profile
        echo "$MOBILEPROVISION_BASE64" | base64 -d > ~/certificates/profile.mobileprovision

        # Create and setup keychain
        security create-keychain -p "build123" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "build123" build.keychain

        # Import certificate
        security import ~/certificates/certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -A
        security set-key-partition-list -S apple-tool:,apple: -s -k "build123" build.keychain

        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp ~/certificates/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

        # List installed certificates
        echo "ðŸ“‹ Installed certificates:"
        security find-identity -v -p codesigning build.keychain

    - name: ðŸŽ Clean & Build iOS
      run: |
        echo "ðŸ§¹ Cleaning previous builds..."
        cd ios
        rm -rf Pods build ~/Library/Developer/Xcode/DerivedData/* || true
        pod deintegrate || true

        echo "ðŸ“¦ Installing CocoaPods..."
        pod install --repo-update --clean-install

        echo "ðŸ—ï¸ Building Flutter iOS..."
        cd ..
        flutter clean
        flutter pub get
        flutter build ios --release --no-codesign --verbose

    - name: ðŸ—ï¸ Create iOS Archive
      run: |
        echo "ðŸ“¦ Creating iOS archive with manual signing..."
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath Runner.xcarchive \
          CODE_SIGN_STYLE="Manual" \
          DEVELOPMENT_TEAM="6CY9Q44KMQ" \
          PROVISIONING_PROFILE_SPECIFIER="Gavra Android New Profile" \
          CODE_SIGN_IDENTITY="iPhone Distribution" \
          archive

    - name: ðŸ“¦ Export IPA for App Store
      run: |
        echo "ðŸ“¤ Exporting IPA for App Store distribution..."
        cd ios
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>6CY9Q44KMQ</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.gavra013.gavra-android</key>
                <string>Gavra Android New Profile</string>
            </dict>
            <key>signingCertificate</key>
            <string>iPhone Distribution</string>
            <key>uploadSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF

        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath export \
          -exportOptionsPlist ExportOptions.plist

    - name: ðŸ”‘ Setup App Store Connect API Key
      env:
        API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      run: |
        echo "ðŸ”‘ Setting up App Store Connect API key..."

        # Create API key directory
        mkdir -p ~/private_keys

        # Decode and save API key
        echo "$API_KEY_BASE64" | base64 -d > ~/private_keys/AuthKey_$API_KEY_ID.p8

        echo "âœ… API key saved to ~/private_keys/AuthKey_$API_KEY_ID.p8"

        # Set permissions
        chmod 600 ~/private_keys/AuthKey_$API_KEY_ID.p8

    - name: ðŸš€ Upload to TestFlight
      env:
        API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      run: |
        echo "ðŸš€ Uploading to TestFlight using API key..."
        cd ios/export

        xcrun altool --upload-app \
          --type ios \
          --file *.ipa \
          --apiKey "$API_KEY_ID" \
          --apiIssuer "$ISSUER_ID" \
          --verbose

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up sensitive files..."
        rm -rf ~/certificates ~/private_keys || true
        security delete-keychain build.keychain || true

    - name: âœ… Success Notification
      run: |
        echo "ðŸŽ‰ iOS app successfully uploaded to TestFlight!"
        echo "ðŸ“± Check App Store Connect for processing status"
        echo "ðŸ”— https://appstoreconnect.apple.com"
