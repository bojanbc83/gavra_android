name: üçé iOS Production Release

on:
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.6'
  BUNDLE_ID: 'com.gavra013.gavra013ios'
  APP_ID: '6757114361'
  VERSION_ID: '91ee99fd-9a91-4592-a148-3dc7f1fc6b01'
  # Hardcoded version 1.0 which already has all metadata

jobs:
  build-and-submit:
    name: üöÄ Build & Submit to App Store
    runs-on: macos-latest
    env:
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Codemagic CLI Tools
        run: pip install codemagic-cli-tools

      - name: Get dependencies
        run: flutter pub get

      - name: Setup keychain
        run: keychain initialize

      - name: Fetch signing files
        run: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create

      - name: Setup certificates
        run: keychain add-certificates

      - name: Setup code signing
        run: xcode-project use-profiles

      - name: Get latest build number
        id: build_info
        run: |
          # Force build number 13 since all previous builds are expired
          # and get-latest-testflight-build-number doesn't count expired builds correctly
          NEW_BUILD=13
          echo "BUILD_NUMBER=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "üì± New build number: $NEW_BUILD"

      - name: Build iOS App
        run: |
          # Using version 1.0 to match existing App Store version
          flutter build ipa --release \
            --build-name=1.0 \
            --build-number=${{ steps.build_info.outputs.BUILD_NUMBER }} \
            --export-options-plist=$HOME/export_options.plist

      - name: Upload to App Store Connect
        run: |
          app-store-connect publish --path build/ios/ipa/*.ipa
          echo "‚úÖ Build uploaded to App Store Connect!"

      - name: Wait for build processing
        run: |
          echo "‚è≥ Waiting 3 minutes for Apple to process build..."
          sleep 180
          echo "‚úÖ Build should be processed now"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Link build and submit for review
        run: |
          npm install jsonwebtoken
          
          node << 'EOF'
          const jwt = require('jsonwebtoken');
          const https = require('https');
          
          const ISSUER_ID = process.env.APP_STORE_CONNECT_ISSUER_ID;
          const KEY_ID = process.env.APP_STORE_CONNECT_KEY_IDENTIFIER;
          const PRIVATE_KEY = process.env.APP_STORE_CONNECT_PRIVATE_KEY;
          const APP_ID = '6757114361';
          const VERSION_ID = '91ee99fd-9a91-4592-a148-3dc7f1fc6b01'; // Existing version 1.0
          const BUILD_NUMBER = '${{ steps.build_info.outputs.BUILD_NUMBER }}';
          
          function generateToken() {
            const now = Math.floor(Date.now() / 1000);
            return jwt.sign(
              { iss: ISSUER_ID, iat: now, exp: now + 1200, aud: 'appstoreconnect-v1' },
              PRIVATE_KEY,
              { algorithm: 'ES256', header: { alg: 'ES256', kid: KEY_ID, typ: 'JWT' } }
            );
          }
          
          function apiRequest(method, path, body = null) {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.appstoreconnect.apple.com',
                path: `/v1${path}`,
                method: method,
                headers: {
                  'Authorization': `Bearer ${generateToken()}`,
                  'Content-Type': 'application/json'
                }
              };
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    resolve({ status: res.statusCode, data: data ? JSON.parse(data) : {} });
                  } else {
                    reject(new Error(`API ${res.statusCode}: ${data}`));
                  }
                });
              });
              
              req.on('error', reject);
              if (body) req.write(JSON.stringify(body));
              req.end();
            });
          }
          
          async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }
          
          async function main() {
            try {
              // 1. Get all builds and find ours by build number
              console.log(`üîç Finding build with number ${BUILD_NUMBER}...`);
              
              // Get recent builds sorted by upload date
              const buildsResponse = await apiRequest('GET', `/builds?filter[app]=${APP_ID}&sort=-uploadedDate&limit=10`);
              const builds = buildsResponse.data.data;
              
              // Find build matching our build number
              let buildId = null;
              for (const build of builds) {
                if (build.attributes.version === BUILD_NUMBER) {
                  buildId = build.id;
                  console.log(`‚úÖ Found build ID: ${buildId}`);
                  break;
                }
              }
              
              if (!buildId) {
                // Build might still be processing, wait and retry
                console.log('‚è≥ Build not found yet, waiting 60 more seconds...');
                await sleep(60000);
                
                const retryResponse = await apiRequest('GET', `/builds?filter[app]=${APP_ID}&sort=-uploadedDate&limit=10`);
                for (const build of retryResponse.data.data) {
                  if (build.attributes.version === BUILD_NUMBER) {
                    buildId = build.id;
                    console.log(`‚úÖ Found build ID on retry: ${buildId}`);
                    break;
                  }
                }
              }
              
              if (!buildId) {
                throw new Error(`Build ${BUILD_NUMBER} not found after waiting!`);
              }
              
              // 2. Link build to existing version 1.0
              console.log(`üîó Linking build to version 1.0 (ID: ${VERSION_ID})...`);
              await apiRequest('PATCH', `/appStoreVersions/${VERSION_ID}/relationships/build`, {
                data: { type: 'builds', id: buildId }
              });
              console.log('‚úÖ Build linked to version!');
              
              // 3. Submit for review using appStoreVersionSubmissions
              console.log('üöÄ Submitting for App Store review...');
              
              try {
                await apiRequest('POST', '/appStoreVersionSubmissions', {
                  data: {
                    type: 'appStoreVersionSubmissions',
                    relationships: {
                      appStoreVersion: {
                        data: { type: 'appStoreVersions', id: VERSION_ID }
                      }
                    }
                  }
                });
                console.log('üéâ Successfully submitted for App Store review!');
              } catch (submitError) {
                console.log('‚ö†Ô∏è appStoreVersionSubmissions failed, trying reviewSubmissions...');
                
                // Try alternative submission method
                const submission = await apiRequest('POST', '/reviewSubmissions', {
                  data: {
                    type: 'reviewSubmissions',
                    attributes: {},
                    relationships: {
                      app: { data: { type: 'apps', id: APP_ID } }
                    }
                  }
                });
                
                const submissionId = submission.data.data.id;
                console.log(`üìù Created review submission: ${submissionId}`);
                
                // Add version to submission
                await apiRequest('POST', '/reviewSubmissionItems', {
                  data: {
                    type: 'reviewSubmissionItems',
                    relationships: {
                      reviewSubmission: { data: { type: 'reviewSubmissions', id: submissionId } },
                      appStoreVersion: { data: { type: 'appStoreVersions', id: VERSION_ID } }
                    }
                  }
                });
                
                // Submit
                await apiRequest('PATCH', `/reviewSubmissions/${submissionId}`, {
                  data: {
                    type: 'reviewSubmissions',
                    id: submissionId,
                    attributes: { submitted: true }
                  }
                });
                
                console.log('üéâ Successfully submitted for App Store review!');
              }
              
            } catch (error) {
              console.error('‚ùå Error:', error.message);
              console.log('');
              console.log('‚ö†Ô∏è Build is uploaded to App Store Connect.');
              console.log('üì± Please go to App Store Connect to manually:');
              console.log('   1. Select build for version 1.0');
              console.log('   2. Click "Add for Review"');
              process.exit(0); // Don't fail workflow - build is uploaded
            }
          }
          
          main();
          EOF

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-build-${{ steps.build_info.outputs.BUILD_NUMBER }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Summary
        run: |
          echo "## üéâ iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** 1.0" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ steps.build_info.outputs.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build uploaded and submitted for App Store review!" >> $GITHUB_STEP_SUMMARY
