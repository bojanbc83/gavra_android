name: ðŸŽ iOS Production Release

on:
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.6'
  BUNDLE_ID: 'com.gavra013.gavra013ios'
  APP_ID: '6757114361'
  VERSION_ID: '91ee99fd-9a91-4592-a148-3dc7f1fc6b01'
  # Hardcoded version 1.0 which already has all metadata

jobs:
  build-and-submit:
    name: ðŸš€ Build & Submit to App Store
    runs-on: macos-latest
    env:
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Codemagic CLI Tools
        run: pip install codemagic-cli-tools

      - name: Get dependencies
        run: flutter pub get

      - name: Setup keychain
        run: keychain initialize

      - name: Fetch signing files
        run: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create

      - name: Setup certificates
        run: keychain add-certificates

      - name: Setup code signing
        run: xcode-project use-profiles

      - name: Get latest build number
        id: build_info
        run: |
          # Hardcoded to 14 - previous builds were 1-13
          NEW_BUILD=14
          echo "BUILD_NUMBER=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "ðŸ“± New build number: $NEW_BUILD"

      - name: Build iOS App
        run: |
          # Using version 1.0 to match existing App Store version
          flutter build ipa --release \
            --build-name=1.0 \
            --build-number=${{ steps.build_info.outputs.BUILD_NUMBER }} \
            --export-options-plist=$HOME/export_options.plist

      - name: Upload to App Store Connect
        run: |
          app-store-connect publish --path build/ios/ipa/*.ipa
          echo "âœ… Build uploaded to App Store Connect!"

      - name: Wait for build processing
        run: |
          echo "â³ Waiting 3 minutes for Apple to process build..."
          sleep 180
          echo "âœ… Build should be processed now"

      - name: Link build to version and submit
        run: |
          BUILD_NUM="${{ steps.build_info.outputs.BUILD_NUMBER }}"
          echo "ðŸ” Looking for build $BUILD_NUM..."
          
          # Wait additional time if needed for build to appear
          for i in 1 2 3; do
            BUILD_ID=$(app-store-connect builds list \
              --app-id "$APP_ID" \
              --build-version-number "$BUILD_NUM" \
              --json 2>/dev/null | python3 -c "import sys,json; data=json.load(sys.stdin); print(data[0]['id'] if data else '')" 2>/dev/null || echo "")
            
            if [ -n "$BUILD_ID" ]; then
              echo "âœ… Found build ID: $BUILD_ID"
              break
            fi
            echo "â³ Build not found yet, waiting 60 seconds (attempt $i/3)..."
            sleep 60
          done
          
          if [ -z "$BUILD_ID" ]; then
            echo "âŒ Could not find build $BUILD_NUM"
            echo "âš ï¸ Build is uploaded. Please manually select it in App Store Connect."
            exit 0
          fi
          
          # Link build to version 1.0
          echo "ðŸ”— Linking build to version 1.0..."
          app-store-connect app-store-versions modify \
            --id "$VERSION_ID" \
            --build-id "$BUILD_ID" || true
          
          # Submit for review
          echo "ðŸš€ Submitting for App Store review..."
          app-store-connect app-store-version-submissions create \
            --app-store-version-id "$VERSION_ID" || {
            echo "âš ï¸ Could not auto-submit. Please submit manually in App Store Connect."
            exit 0
          }
          
          echo "ðŸŽ‰ Successfully submitted for App Store review!"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-build-${{ steps.build_info.outputs.BUILD_NUMBER }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸŽ‰ iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** 1.0" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ steps.build_info.outputs.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build uploaded and submitted for App Store review!" >> $GITHUB_STEP_SUMMARY
