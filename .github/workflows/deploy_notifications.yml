name: Deploy Notifications (Supabase)

on:
  workflow_dispatch:
    inputs:
      SUPABASE_URL:
        description: 'Supabase project URL'
        required: false
      SUPABASE_SERVICE_ROLE_KEY:
        description: 'Supabase service role key (secret)'
        required: false

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Pre-deploy: Check push_players for test driver (optional)
        if: ${{ secrets.TEST_TARGET_DRIVER_ID }}
        shell: pwsh
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          TEST_TARGET_DRIVER_ID: ${{ secrets.TEST_TARGET_DRIVER_ID }}
        run: |
          if (Test-Path .\supabase\scripts\check_push_players.ps1) {
            pwsh .\supabase\scripts\check_push_players.ps1 -SupabaseUrl $env:SUPABASE_URL -ServiceRole $env:SUPABASE_SERVICE_ROLE_KEY -DriverId $env:TEST_TARGET_DRIVER_ID
          } else {
            Write-Host "check_push_players.ps1 not present; skipping pre-deploy check" -ForegroundColor Yellow
          }

      - name: Ensure android/app exists
        shell: pwsh
        run: |
          if (!(Test-Path -Path android/app)) { New-Item -ItemType Directory -Path android/app -Force | Out-Null }

      - name: Write agconnect-services.json (if provided)
        if: ${{ secrets.AGCONNECT_JSON }}
        shell: pwsh
        run: |
          $json = '${{ secrets.AGCONNECT_JSON }}'
          $json | Out-File -FilePath android/app/agconnect-services.json -Encoding utf8 -Force

      - name: Install supabase cli
        shell: pwsh
        run: npm i -g supabase

      - name: Set required env
        shell: pwsh
        run: |
          Write-Host 'Setting environment variables for the run (secrets pulled from repository settings)'

      - name: Run auto set + deploy
        shell: pwsh
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          FCM_SERVER_KEY: ${{ secrets.FCM_SERVER_KEY }}
          HUAWEI_APP_ID: ${{ secrets.HUAWEI_APP_ID }}
          HUAWEI_APP_SECRET: ${{ secrets.HUAWEI_APP_SECRET }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          FCM_PROJECT_ID: ${{ secrets.FCM_PROJECT_ID }}
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File .\supabase\scripts\auto_set_deploy.ps1 -SupabaseUrl $env:SUPABASE_URL -ServiceRole $env:SUPABASE_SERVICE_ROLE_KEY -FcmServerKey $env:FCM_SERVER_KEY -HuaweiAppId $env:HUAWEI_APP_ID -HuaweiAppSecret $env:HUAWEI_APP_SECRET -AgconnectPath 'android/app/agconnect-services.json' -GoogleServiceAccountJson "$env:GOOGLE_SERVICE_ACCOUNT_JSON" -FcmProjectId $env:FCM_PROJECT_ID -VerifyHuawei -Deploy

      - name: Post-deploy: Acceptance test (optional)
        if: ${{ secrets.TEST_TARGET_DRIVER_ID }}
        shell: pwsh
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          TEST_TARGET_DRIVER_ID: ${{ secrets.TEST_TARGET_DRIVER_ID }}
        run: |
          # Call the Edge function to send a push to a test driver ID. It will return success if function executed.
          $payload = @{ title = 'CI Test'; body = 'Test push - acceptance'; driver_ids = @($env:TEST_TARGET_DRIVER_ID) } | ConvertTo-Json -Depth 4
          $url = "https://$($env:SUPABASE_URL -replace 'https?://','')/functions/v1/send-push-notification"
          $response = Invoke-RestMethod -Uri $url -Headers @{ 'apikey' = $env:SUPABASE_SERVICE_ROLE_KEY; 'Authorization' = "Bearer $($env:SUPABASE_SERVICE_ROLE_KEY)" } -Method Post -ContentType 'application/json' -Body $payload
          Write-Host "Acceptance test result: $($response | ConvertTo-Json -Depth 4)"
          # Validate legacy FCM response (success/failure fields) or v1 responses
          try {
            if ($response.success -eq $true) { Write-Host 'FCM legacy send marked success' -ForegroundColor Green } 
            elseif ($response.success -eq $false -and ($null -ne $response.failure)) { Write-Host 'FCM legacy send failed' -ForegroundColor Yellow }
            else { Write-Host 'FCM v1 or custom response; acceptance test relies on push_players checks' -ForegroundColor Cyan }
          } catch { Write-Host 'Could not parse response success field; continuing' -ForegroundColor Yellow }
          # Validate tokens using helper script when available
          if (Test-Path .\supabase\scripts\check_push_players.ps1) {
            pwsh .\supabase\scripts\check_push_players.ps1 -SupabaseUrl $env:SUPABASE_URL -ServiceRole $env:SUPABASE_SERVICE_ROLE_KEY -DriverId $env:TEST_TARGET_DRIVER_ID -FailIfNone
          } else {
            # Fallback: direct REST check
            $projectHost = ($env:SUPABASE_URL -replace 'https?://','')
            $checkUrl = "https://$projectHost/rest/v1/push_players?select=player_id,provider,platform,is_active&driver_id=eq.$($env:TEST_TARGET_DRIVER_ID)&is_active=eq.true"
            $rows = Invoke-RestMethod -Uri $checkUrl -Method Get -Headers @{ 'apikey' = $env:SUPABASE_SERVICE_ROLE_KEY; 'Authorization' = "Bearer $($env:SUPABASE_SERVICE_ROLE_KEY)" }
            if (-not $rows -or $rows.Count -eq 0) {
              Write-Host "FAIL: No active push players found for driver $($env:TEST_TARGET_DRIVER_ID)" -ForegroundColor Red
              exit 1
            } else {
              Write-Host "OK: Found $($rows.Count) active push players for driver $($env:TEST_TARGET_DRIVER_ID)" -ForegroundColor Green
            }
          }

      - name: Done
        shell: pwsh
        run: Write-Host 'Done: deploy flow ran. Check supabase function logs for further info.'
