name: iOS Screenshots

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  screenshots:
    runs-on: macos-latest  # macOS 15 with latest Xcode
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Create iPhone 16 Plus Simulator
        run: |
          # Use existing iPhone 16 Plus from iOS 18.4
          # Get UDID of existing iPhone 16 Plus (UUID format: 36 chars with dashes)
          IPHONE_UDID=$(xcrun simctl list devices available | grep "iPhone 16 Plus" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "Using existing iPhone 16 Plus: $IPHONE_UDID"
          
          # If no existing, create one with full runtime ID
          if [ -z "$IPHONE_UDID" ]; then
            RUNTIME=$(xcrun simctl list runtimes | grep "iOS 18" | head -1 | awk '{print $NF}')
            echo "Creating new simulator with runtime: $RUNTIME"
            xcrun simctl create "iPhone16Plus" "iPhone 16 Plus" "$RUNTIME" || true
            IPHONE_UDID="iPhone16Plus"
          fi
          
          # Boot the simulator
          xcrun simctl boot "$IPHONE_UDID" || true
          
          # Save UDID for later steps
          echo "IPHONE_UDID=$IPHONE_UDID" >> $GITHUB_ENV
          
          # Wait for boot
          sleep 10

      - name: Create iPad Pro 13-inch Simulator  
        run: |
          # Use existing iPad Pro 13-inch (M4) from iOS 18.4
          # Extract UDID (last thing in parentheses - the UUID format)
          IPAD_UDID=$(xcrun simctl list devices available | grep "iPad Pro 13-inch (M4)" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "Using existing iPad Pro 13-inch: $IPAD_UDID"
          
          # Save UDID for later steps
          echo "IPAD_UDID=$IPAD_UDID" >> $GITHUB_ENV

      - name: Build iOS app
        run: |
          # Update CocoaPods to get latest Firebase compatible with Xcode 16
          cd ios
          pod repo update
          pod update FirebaseCore FirebaseCoreInternal FirebaseMessaging || true
          cd ..
          
          # Build for simulator
          flutter build ios --simulator --no-codesign

      - name: Take iPhone Screenshots with Integration Test
        run: |
          mkdir -p screenshots/iphone
          
          # Use UDID from previous step
          echo "Using iPhone: $IPHONE_UDID"
          
          # Ensure simulator is booted
          xcrun simctl boot "$IPHONE_UDID" 2>/dev/null || true
          sleep 5
          
          # Fallback: Manual screenshots
          echo "Taking manual screenshots..."
          
          # Install app on simulator
          xcrun simctl install "$IPHONE_UDID" build/ios/iphonesimulator/Runner.app
          
          # Launch app
          xcrun simctl launch "$IPHONE_UDID" com.gavra013.gavra013ios
          sleep 8
          
          # Take screenshots
          xcrun simctl io "$IPHONE_UDID" screenshot screenshots/iphone/01_welcome.png
          sleep 3
          xcrun simctl io "$IPHONE_UDID" screenshot screenshots/iphone/02_screen.png
          sleep 3
          xcrun simctl io "$IPHONE_UDID" screenshot screenshots/iphone/03_screen.png
          
          # Ensure we have at least 3 screenshots
          ls -la screenshots/iphone/

      - name: Take iPad Screenshots
        run: |
          mkdir -p screenshots/ipad
          
          # Shutdown iPhone first
          xcrun simctl shutdown "$IPHONE_UDID" || true
          
          echo "Using iPad: $IPAD_UDID"
          
          # Boot iPad simulator
          xcrun simctl boot "$IPAD_UDID" || true
          sleep 10
          
          # Install app on iPad simulator
          xcrun simctl install "$IPAD_UDID" build/ios/iphonesimulator/Runner.app
          
          # Launch app
          xcrun simctl launch "$IPAD_UDID" com.gavra013.gavra013ios
          sleep 8
          
          # Screenshot iPad - minimum 3
          xcrun simctl io "$IPAD_UDID" screenshot screenshots/ipad/01_ipad_welcome.png
          sleep 3
          xcrun simctl io "$IPAD_UDID" screenshot screenshots/ipad/02_ipad_screen.png
          sleep 3
          xcrun simctl io "$IPAD_UDID" screenshot screenshots/ipad/03_ipad_screen.png
          
          ls -la screenshots/ipad/

      - name: List screenshots
        run: |
          echo "=== iPhone Screenshots ==="
          ls -la screenshots/iphone/
          echo ""
          echo "=== iPad Screenshots ==="
          ls -la screenshots/ipad/
          echo ""
          echo "=== Screenshot dimensions ==="
          for f in screenshots/iphone/*.png; do
            echo "$f: $(file "$f" | grep -o '[0-9]* x [0-9]*')"
          done
          for f in screenshots/ipad/*.png; do
            echo "$f: $(file "$f" | grep -o '[0-9]* x [0-9]*')"
          done

      - name: Upload iPhone Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: iphone-screenshots-1284x2778
          path: screenshots/iphone/
          retention-days: 30

      - name: Upload iPad Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: ipad-screenshots-2048x2732
          path: screenshots/ipad/
          retention-days: 30

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: all-ios-screenshots
          path: screenshots/
          retention-days: 30
