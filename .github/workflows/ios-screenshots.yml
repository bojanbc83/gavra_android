name: iOS Screenshots

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  screenshots:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Get iPhone UDID
        run: |
          # Get UDID of iPhone 16 Plus
          IPHONE_UDID=$(xcrun simctl list devices available | grep "iPhone 16 Plus" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "iPhone 16 Plus UDID: $IPHONE_UDID"
          echo "IPHONE_UDID=$IPHONE_UDID" >> $GITHUB_ENV

      - name: Get iPad UDID
        run: |
          # Get UDID of iPad Pro 13-inch (M4)
          IPAD_UDID=$(xcrun simctl list devices available | grep "iPad Pro 13-inch (M4)" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "iPad Pro 13-inch UDID: $IPAD_UDID"
          echo "IPAD_UDID=$IPAD_UDID" >> $GITHUB_ENV

      - name: Boot iPhone Simulator
        run: |
          xcrun simctl boot "$IPHONE_UDID" || true
          sleep 10
          # Grant all permissions
          xcrun simctl privacy "$IPHONE_UDID" grant all com.gavra013.gavra013ios || true

      - name: Build iOS app for simulator
        run: |
          cd ios
          pod repo update
          pod update FirebaseCore FirebaseCoreInternal FirebaseMessaging || true
          cd ..
          flutter build ios --simulator --no-codesign

      - name: Run Integration Test on iPhone
        run: |
          mkdir -p screenshots/iphone
          
          # Run integration test with the iPhone simulator
          flutter test integration_test/screenshot_test.dart \
            -d "$IPHONE_UDID" \
            --dart-define=SCREENSHOT_MODE=true || true
          
          # Move screenshots to iphone folder
          mv screenshots/*.png screenshots/iphone/ 2>/dev/null || true
          
          ls -la screenshots/iphone/ || echo "No screenshots in iphone folder"

      - name: Shutdown iPhone, Boot iPad
        run: |
          xcrun simctl shutdown "$IPHONE_UDID" || true
          sleep 5
          xcrun simctl boot "$IPAD_UDID" || true
          sleep 10
          # Grant all permissions
          xcrun simctl privacy "$IPAD_UDID" grant all com.gavra013.gavra013ios || true

      - name: Run Integration Test on iPad
        run: |
          mkdir -p screenshots/ipad
          
          # Clean screenshots folder first
          rm -f screenshots/*.png 2>/dev/null || true
          
          # Run integration test with the iPad simulator
          flutter test integration_test/screenshot_test.dart \
            -d "$IPAD_UDID" \
            --dart-define=SCREENSHOT_MODE=true || true
          
          # Move screenshots to ipad folder
          mv screenshots/*.png screenshots/ipad/ 2>/dev/null || true
          
          ls -la screenshots/ipad/ || echo "No screenshots in ipad folder"

      - name: Fallback - Manual Screenshots (if integration test failed)
        run: |
          # Check if we got screenshots
          IPHONE_COUNT=$(ls -1 screenshots/iphone/*.png 2>/dev/null | wc -l || echo 0)
          IPAD_COUNT=$(ls -1 screenshots/ipad/*.png 2>/dev/null | wc -l || echo 0)
          
          echo "iPhone screenshots: $IPHONE_COUNT"
          echo "iPad screenshots: $IPAD_COUNT"
          
          # If no screenshots, take manual ones
          if [ "$IPHONE_COUNT" -eq 0 ]; then
            echo "Taking manual iPhone screenshots..."
            xcrun simctl boot "$IPHONE_UDID" 2>/dev/null || true
            sleep 5
            xcrun simctl install "$IPHONE_UDID" build/ios/iphonesimulator/Runner.app
            xcrun simctl launch "$IPHONE_UDID" com.gavra013.gavra013ios
            sleep 8
            xcrun simctl io "$IPHONE_UDID" screenshot screenshots/iphone/01_permissions.png
            sleep 5
            xcrun simctl io "$IPHONE_UDID" screenshot screenshots/iphone/02_welcome.png
            sleep 5
            xcrun simctl io "$IPHONE_UDID" screenshot screenshots/iphone/03_screen.png
          fi
          
          if [ "$IPAD_COUNT" -eq 0 ]; then
            echo "Taking manual iPad screenshots..."
            xcrun simctl shutdown "$IPHONE_UDID" 2>/dev/null || true
            xcrun simctl boot "$IPAD_UDID" 2>/dev/null || true
            sleep 5
            xcrun simctl install "$IPAD_UDID" build/ios/iphonesimulator/Runner.app
            xcrun simctl launch "$IPAD_UDID" com.gavra013.gavra013ios
            sleep 8
            xcrun simctl io "$IPAD_UDID" screenshot screenshots/ipad/01_ipad_permissions.png
            sleep 5
            xcrun simctl io "$IPAD_UDID" screenshot screenshots/ipad/02_ipad_welcome.png
            sleep 5
            xcrun simctl io "$IPAD_UDID" screenshot screenshots/ipad/03_ipad_screen.png
          fi

      - name: List all screenshots
        run: |
          echo "=== iPhone Screenshots ==="
          ls -la screenshots/iphone/ || echo "No iPhone screenshots"
          echo ""
          echo "=== iPad Screenshots ==="
          ls -la screenshots/ipad/ || echo "No iPad screenshots"
          echo ""
          echo "=== Screenshot dimensions ==="
          for f in screenshots/iphone/*.png 2>/dev/null; do
            [ -f "$f" ] && echo "$f: $(file "$f" | grep -o '[0-9]* x [0-9]*')"
          done
          for f in screenshots/ipad/*.png 2>/dev/null; do
            [ -f "$f" ] && echo "$f: $(file "$f" | grep -o '[0-9]* x [0-9]*')"
          done

      - name: Upload iPhone Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: iphone-screenshots-1284x2778
          path: screenshots/iphone/
          retention-days: 30

      - name: Upload iPad Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: ipad-screenshots-2048x2732
          path: screenshots/ipad/
          retention-days: 30

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: all-ios-screenshots
          path: screenshots/
          retention-days: 30
