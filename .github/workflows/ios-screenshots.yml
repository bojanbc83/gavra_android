name: iOS Screenshots

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  screenshots:
    runs-on: macos-13  # macOS Ventura with Xcode 14/15 - compatible with Firebase
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Create iPhone 14 Plus Simulator
        run: |
          # Get the runtime identifier for iOS 17
          RUNTIME=$(xcrun simctl list runtimes | grep "iOS 17" | tail -1 | awk -F'[()]' '{print $2}' | awk '{print $1}')
          echo "Using runtime: $RUNTIME"
          
          # Create iPhone 14 Plus simulator (6.7" but renders at 1284x2778 - 6.5" size)
          # Or iPhone 11 Pro Max which is native 6.5"
          xcrun simctl create "iPhone14Plus" "iPhone 14 Plus" "$RUNTIME" || true
          
          # Boot the simulator
          xcrun simctl boot "iPhone14Plus" || true
          
          # Wait for boot
          sleep 10

      - name: Create iPad Pro 12.9 Simulator  
        run: |
          RUNTIME=$(xcrun simctl list runtimes | grep "iOS 17" | tail -1 | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Create iPad Pro 12.9 simulator
          xcrun simctl create "iPadPro129" "iPad Pro (12.9-inch) (6th generation)" "$RUNTIME" || true

      - name: Build iOS app
        run: |
          flutter build ios --simulator --no-codesign

      - name: Take iPhone Screenshots with Integration Test
        run: |
          mkdir -p screenshots/iphone
          
          # Boot iPhone simulator
          xcrun simctl boot "iPhone14Plus" || true
          sleep 10
          
          # Run integration test that takes screenshots
          flutter test integration_test/screenshot_test.dart \
            -d "iPhone14Plus" \
            --dart-define=SCREENSHOTS=true || true
          
          # Fallback: Manual screenshots if test fails
          if [ ! -f screenshots/01_welcome_screen.png ]; then
            echo "Integration test didn't create screenshots, taking manual ones..."
            
            # Install app on simulator
            xcrun simctl install "iPhone14Plus" build/ios/iphonesimulator/Runner.app
            
            # Launch app
            xcrun simctl launch "iPhone14Plus" com.gavra013.gavra013ios
            sleep 8
            
            # Take screenshots
            xcrun simctl io "iPhone14Plus" screenshot screenshots/iphone/01_welcome.png
            sleep 3
            xcrun simctl io "iPhone14Plus" screenshot screenshots/iphone/02_screen.png
            sleep 3
            xcrun simctl io "iPhone14Plus" screenshot screenshots/iphone/03_screen.png
          fi
          
          # Move any screenshots from root to iphone folder
          mv screenshots/*.png screenshots/iphone/ 2>/dev/null || true
          
          # Ensure we have at least 3 screenshots
          ls -la screenshots/iphone/

      - name: Take iPad Screenshots
        run: |
          mkdir -p screenshots/ipad
          
          # Shutdown iPhone first
          xcrun simctl shutdown "iPhone14Plus" || true
          
          # Boot iPad simulator
          xcrun simctl boot "iPadPro129" || true
          sleep 10
          
          # Install app on iPad simulator
          xcrun simctl install "iPadPro129" build/ios/iphonesimulator/Runner.app
          
          # Launch app
          xcrun simctl launch "iPadPro129" com.gavra013.gavra013ios
          sleep 8
          
          # Screenshot iPad - minimum 3
          xcrun simctl io "iPadPro129" screenshot screenshots/ipad/01_ipad_welcome.png
          sleep 3
          xcrun simctl io "iPadPro129" screenshot screenshots/ipad/02_ipad_screen.png
          sleep 3
          xcrun simctl io "iPadPro129" screenshot screenshots/ipad/03_ipad_screen.png
          
          ls -la screenshots/ipad/

      - name: List screenshots
        run: |
          echo "=== iPhone Screenshots ==="
          ls -la screenshots/iphone/
          echo ""
          echo "=== iPad Screenshots ==="
          ls -la screenshots/ipad/
          echo ""
          echo "=== Screenshot dimensions ==="
          for f in screenshots/iphone/*.png; do
            echo "$f: $(file "$f" | grep -o '[0-9]* x [0-9]*')"
          done
          for f in screenshots/ipad/*.png; do
            echo "$f: $(file "$f" | grep -o '[0-9]* x [0-9]*')"
          done

      - name: Upload iPhone Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: iphone-screenshots-1284x2778
          path: screenshots/iphone/
          retention-days: 30

      - name: Upload iPad Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: ipad-screenshots-2048x2732
          path: screenshots/ipad/
          retention-days: 30

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: all-ios-screenshots
          path: screenshots/
          retention-days: 30
