name: ğŸš€ Build and Release APK

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build:
    name: ğŸ“± Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
        channel: 'stable'
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    - name: ğŸ§ª Run Tests
      run: flutter test
      continue-on-error: true
      
    - name: ğŸ”¨ Build Debug APK
      run: |
        echo "Building debug APK for: ${{ github.ref_name }}"
        flutter build apk --debug --target-platform android-arm64
        
    - name: ğŸ“ Upload Release APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gavra-android-debug-${{ github.ref_name }}
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 90

  release:
    name: ğŸ‰ Update Latest Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“± Download APK
      uses: actions/download-artifact@v4
      with:
        name: gavra-android-debug-${{ github.ref_name }}
        path: ./artifacts/
        
    - name: ï¿½ï¸ Delete Latest Release
      run: |
        # ObriÅ¡i latest release ako postoji
        gh release delete latest --yes || true
        git push origin :refs/tags/latest || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ‰ Create New Latest Release
      run: |
        # Kreiraj novi latest release
        gh release create latest ./artifacts/app-debug.apk \
          --title "ğŸš€ Gavra Android - Latest Build" \
          --notes "ğŸ“± **Automatski build sa commit:** ${{ github.sha }}

        ### ğŸ“± QR Code Download:
        Skenuj QR kod za direktan download:
        \`\`\`
        https://github.com/${{ github.repository }}/releases/latest/download/app-debug.apk
        \`\`\`
        
        ### ğŸ”„ Poslednje promene:
        $(git log --oneline -5)
        
        **Build vreme:** $(date '+%d.%m.%Y %H:%M')
        **Commit:** ${{ github.sha }}" \
          --latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}