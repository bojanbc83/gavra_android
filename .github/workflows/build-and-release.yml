name: ðŸš€ Build and Release APK

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: ðŸ“± Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
        channel: 'stable'
        
    - name: ðŸ“¦ Get Dependencies
      run: flutter pub get
      
    - name: ðŸ§ª Run Tests
      run: flutter test
      continue-on-error: true
      
    - name: ðŸ”¨ Build Debug APK (for main branch)
      if: github.ref == 'refs/heads/main'
      run: flutter build apk --debug --target-platform android-arm64
      
    - name: ðŸ”¨ Build Release APK (for tags)
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "Building release APK for tag: ${{ github.ref_name }}"
        flutter build apk --release --target-platform android-arm64
        
    - name: ðŸ“ Upload Debug APK Artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v3
      with:
        name: gavra-android-debug
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 30
        
    - name: ðŸ“ Upload Release APK Artifact
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v3
      with:
        name: gavra-android-release-${{ github.ref_name }}
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 90

  release:
    name: ðŸŽ‰ Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“± Download Release APK
      uses: actions/download-artifact@v3
      with:
        name: gavra-android-release-${{ github.ref_name }}
        path: ./artifacts/
        
    - name: ðŸ“ Extract Version Info
      id: version_info
      run: |
        VERSION=${GITHUB_REF_NAME#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
        
        # Extract changelog from git commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD)
        else
          CHANGELOG=$(git log --pretty=format:"- %s" -10)
        fi
        
        # Create release notes
        cat > release_notes.md << EOF
        ## ðŸš€ Gavra Android v$VERSION
        
        ### ðŸ“± Download APK:
        - **gavra-android-v$VERSION.apk** - Verzija-specifiÄan APK
        - **gavra-android-latest.apk** - Uvek najnovija verzija (QR Code friendly)
        
        ### ðŸ“± QR Code Download:
        Skenuj QR kod za direktan download najnovije verzije:
        \`\`\`
        https://github.com/${{ github.repository }}/releases/latest/download/gavra-android-latest.apk
        \`\`\`
        
        ### ðŸ”„ Å ta je novo:
        $CHANGELOG
        
        ### ðŸ“‹ Instalacija:
        1. Skini **app-release.apk** fajl
        2. OmoguÄ‡i "Unknown sources" u Android settings
        3. Instaliraj APK
        4. UÅ¾ivaj! ðŸŽ‰
        
        ### â„¹ï¸ Info:
        - Verzija: $VERSION
        - Build: ${{ github.sha }}
        - Datum: $(date '+%d.%m.%Y %H:%M')
        EOF
        
    - name: ðŸŽ‰ Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: ðŸš€ Gavra Android ${{ steps.version_info.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        
    - name: ðŸ“Ž Upload APK to Release (Versioned)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/app-release.apk
        asset_name: gavra-android-v${{ steps.version_info.outputs.version }}.apk
        asset_content_type: application/vnd.android.package-archive
        
    - name: ðŸ“± Upload APK to Release (QR Code Friendly)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/app-release.apk
        asset_name: gavra-android-latest.apk
        asset_content_type: application/vnd.android.package-archive
        
    - name: ðŸŽ¯ Post-Release Actions
      run: |
        echo "âœ… Release ${{ steps.version_info.outputs.tag_name }} uspeÅ¡no kreiran!"
        echo "ðŸ“± APK dostupan na: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version_info.outputs.tag_name }}"
        echo "ðŸ”— Update checker Ä‡e automatski detektovati novu verziju"
        echo ""
        echo "ðŸ“± QR Code direktan download link:"
        echo "https://github.com/${{ github.repository }}/releases/latest/download/gavra-android-latest.apk"
        echo ""
        echo "ðŸŽ¯ Za QR kod generiÅ¡i link: https://github.com/${{ github.repository }}/releases/latest/download/gavra-android-latest.apk"