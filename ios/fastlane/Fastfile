default_platform(:ios)

platform :ios do
  desc "Build iOS app for cloud CI/CD (GitHub Actions only)"
  lane :build_cloud do
    puts "ğŸ” Environment Variables Check:"
    puts "IOS_CERTIFICATE_BASE64 present: #{!ENV['IOS_CERTIFICATE_BASE64'].nil?}"
    puts "IOS_CERTIFICATE_PASSWORD present: #{!ENV['IOS_CERTIFICATE_PASSWORD'].nil?}"
    puts "IOS_PROVISIONING_PROFILE_BASE64 present: #{!ENV['IOS_PROVISIONING_PROFILE_BASE64'].nil?}"
    
    # Detect and set available Xcode version
    puts "ğŸ” Detecting Xcode installations..."
    xcode_paths = [
      "/Applications/Xcode_15.4.app",
      "/Applications/Xcode_15.3.app", 
      "/Applications/Xcode_15.2.app",
      "/Applications/Xcode_15.1.app",
      "/Applications/Xcode_15.0.app",
      "/Applications/Xcode.app"
    ]
    
    selected_xcode = nil
    xcode_paths.each do |path|
      if File.exist?("#{path}/Contents/Developer")
        selected_xcode = path
        puts "âœ… Found Xcode at: #{path}"
        break
      else
        puts "âŒ No Xcode at: #{path}"
      end
    end
    
    if selected_xcode.nil?
      raise "âŒ No valid Xcode installation found!"
    end
    
    # Set Xcode path
    xcode_select(selected_xcode)
    puts "ğŸ”¨ Using Xcode: #{selected_xcode}"
    
    # Create keychain for code signing
    create_keychain(
      name: "ios-build.keychain",
      password: "",
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )
    
    # Install certificate from environment variables (cloud only)
    certificate_path = File.expand_path("../ios_distribution.p12")
    puts "Creating certificate at: #{certificate_path}"
    
    begin
      # Mandatory environment variable for cloud build
      certificate_base64 = ENV['IOS_CERTIFICATE_BASE64']
      if certificate_base64.nil? || certificate_base64.empty?
        raise "âŒ IOS_CERTIFICATE_BASE64 environment variable is required for cloud build"
      end
      File.write(certificate_path, Base64.decode64(certificate_base64))
      puts "âœ… Certificate file created: #{File.size(certificate_path)} bytes"
    rescue => e
      puts "âŒ Error creating certificate: #{e.message}"
      raise e
    end

    # Get password from environment variable (mandatory)
    cert_password = ENV["IOS_CERTIFICATE_PASSWORD"]
    if cert_password.nil? || cert_password.empty?
      raise "âŒ IOS_CERTIFICATE_PASSWORD environment variable is required"
    end
    puts "ğŸ”¨ Using certificate password from environment"
    
    begin
      import_certificate(
        certificate_path: certificate_path,
        certificate_password: cert_password,
        keychain_name: "ios-build.keychain",
        keychain_password: ""
      )
      puts "âœ… Certificate imported successfully"
    rescue => e
      puts "âŒ Error importing certificate: #{e.message}"
      raise e
    end

    # Install provisioning profile from environment variables (cloud only)
    profile_path = File.expand_path("../ios_profile.mobileprovision")
    puts "Creating provisioning profile at: #{profile_path}"

    begin
      # Mandatory environment variable for cloud build
      profile_base64 = ENV['IOS_PROVISIONING_PROFILE_BASE64']
      if profile_base64.nil? || profile_base64.empty?
        raise "âŒ IOS_PROVISIONING_PROFILE_BASE64 environment variable is required for cloud build"
      end
      
      File.write(profile_path, Base64.decode64(profile_base64))
      puts "âœ… Provisioning profile created: #{File.size(profile_path)} bytes"
      install_provisioning_profile(path: profile_path)
    rescue => e
      puts "âŒ Error creating provisioning profile: #{e.message}"
      raise e
    end
    
    # Build the app
    puts "ğŸ”¨ Starting iOS build process..."
    workspace_path = File.expand_path("../Runner.xcworkspace")
    puts "Workspace path: #{workspace_path}"
    puts "Workspace exists: #{File.exist?(workspace_path)}"
    
    begin
      build_app(
        workspace: workspace_path,
        scheme: "Runner",
        configuration: "Release",
        export_method: "app-store",
        destination: "generic/platform=iOS",
        sdk: "iphoneos",
        skip_package_dependencies_resolution: true,
        xcargs: "DEVELOPMENT_TEAM=6CY9Q44KMQ CODE_SIGN_STYLE=Automatic IPHONEOS_DEPLOYMENT_TARGET=14.0",
        export_options: {
          method: "app-store",
          teamID: "6CY9Q44KMQ",
          signingStyle: "automatic"
        }
      )
      puts "âœ… Build completed successfully!"
      
      # Check what files were created
      puts "ğŸ“ Checking build output files..."
      Dir.glob("**/*.ipa").each do |ipa_file|
        puts "Found IPA: #{ipa_file} (#{File.size(ipa_file)} bytes)"
      end
      
      # Try to find the IPA file
      ipa_path = Actions.lane_context[SharedValues::IPA_OUTPUT_PATH]
      if ipa_path && File.exist?(ipa_path)
        puts "âœ… Found IPA at lane context path: #{ipa_path}"
      else
        puts "âš ï¸  IPA not found at lane context path: #{ipa_path}"
        # Look for IPA files in common locations
        possible_ipa_paths = [
          "./Runner.ipa",
          "./build/ios/iphoneos/Runner.ipa",
          "../build/ios/ipa/Runner.ipa"
        ]
        
        possible_ipa_paths.each do |path|
          if File.exist?(path)
            puts "âœ… Found IPA at: #{path}"
            ipa_path = path
            break
          end
        end
      end
      
      if ipa_path && File.exist?(ipa_path)
        puts "ğŸ“± Final IPA path: #{ipa_path}"
        puts "ğŸ“ IPA size: #{File.size(ipa_path)} bytes"
      else
        puts "âŒ No IPA file found!"
      end
      
    rescue => e
      puts "âŒ Build failed: #{e.message}"
      raise e
    end
  end

  desc "Upload to TestFlight using App Store Connect API"
  lane :upload_testflight do
    puts "ğŸš€ Uploading to TestFlight..."
    
    # Find the IPA file
    ipa_path = Actions.lane_context[SharedValues::IPA_OUTPUT_PATH] || 
               Dir.glob("**/*.ipa").first
    
    if ipa_path.nil? || !File.exist?(ipa_path)
      raise "âŒ No IPA file found for upload"
    end
    
    puts "ğŸ“± Uploading IPA: #{ipa_path}"
    
    begin
      upload_to_testflight(
        api_key_path: "../AuthKey_F4P3BUR78G.p8",
        api_key: {
          key_id: "F4P3BUR78G",
          issuer_id: "d8b50e72-6330-401d-9aef-4ead356405ca",
          key_filepath: "../AuthKey_F4P3BUR78G.p8"
        },
        skip_waiting_for_build_processing: true,
        skip_submission: true,
        ipa: ipa_path
      )
      puts "âœ… Successfully uploaded to TestFlight!"
    rescue => e
      puts "âŒ TestFlight upload failed: #{e.message}"
      raise e
    end
  end

  desc "Complete build and upload process"
  lane :build_and_upload do
    build_cloud
    upload_testflight
  end
end
