rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // ==============================================================================
    // GAVRA 013 - PRODUCTION FIRESTORE SECURITY RULES
    // Created during Supabase â†’ Firebase migration
    // ==============================================================================

    // ğŸ‘¤ AUTHENTICATED USERS ONLY
    function isAuthenticated() {
      return request.auth != null;
    }

    // ğŸ‘¨â€ğŸ’¼ USER OWNS RESOURCE
    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    // ğŸšŒ VOZACI COLLECTION - Only authenticated drivers can read/write their own data
    match /vozaci/{vozacId} {
      allow read, write: if isAuthenticated() && isOwner(vozacId);
    }

    // ğŸ‘¥ MESECNI PUTNICI - Only authenticated users can manage their passengers
    match /mesecni_putnici/{putnikId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.vozac_id);
      allow create: if isAuthenticated();
    }

    // ğŸ« DNEVNI PUTNICI - Only authenticated users can manage their passengers  
    match /dnevni_putnici/{putnikId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.vozac_id);
      allow create: if isAuthenticated();
    }

    // ğŸ“ ADRESE - All authenticated users can read addresses
    match /adrese/{adresaId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Drivers can add new addresses
    }

    // ğŸš— VOZILA - Only vehicle owners can modify their vehicles
    match /vozila/{voziloId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(resource.data.vlasnik_id);
    }

    // ğŸ›£ï¸ PUTOVANJA ISTORIJA - Drivers can read/write their trip history
    match /putovanja_istorija/{putovanjeId} {
      allow read, write: if isAuthenticated() && isOwner(resource.data.vozac_id);
      allow create: if isAuthenticated();
    }

    // ğŸ“ GPS LOKACIJE - Real-time GPS tracking for active trips
    match /gps_lokacije/{lokacijaId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(resource.data.vozac_id);
      allow create: if isAuthenticated();
    }

    // ğŸ—ºï¸ RUTE - All authenticated users can read routes
    match /rute/{rutaId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Drivers can optimize routes
    }

    // ğŸ“Š ANALYTICS & SYSTEM COLLECTIONS (read-only for users)
    match /system_stats/{document} {
      allow read: if isAuthenticated();
      allow write: if false; // Only backend can write system stats
    }

    // ğŸ”” NOTIFICATIONS (users can read their own notifications)
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.user_id);
      allow write: if false; // Only backend creates notifications
    }
  }
}